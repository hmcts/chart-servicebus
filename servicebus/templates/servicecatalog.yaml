{{- $globals := .Values.global | default dict -}}
{{- $tags := $globals.tags | default dict -}}
---
apiVersion: servicebus.azure.com/v1beta20210101preview
kind: Namespace
metadata:
  name: servicebus-namespace-{{ template "hmcts.servicebus.releaseName" . }}
spec:
  tags:
    helm.sh_chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    app.kubernetes.io_name: {{ template "hmcts.servicebus.releaseName" . }}
    application: {{ required "An application tag name (.Values.tags.applicationName) is required"  (.Values.tags.applicationName | default $tags.applicationName) }}
    builtFrom: {{ required "Repo built from (.Values.tags.builtFrom) is required" (.Values.tags.builtFrom | default $tags.builtFrom) }}
    businessArea: {{ required "Business Area name (.Values.tags.businessArea) is required" (.Values.tags.businessArea | default $tags.businessArea) }}
    environment: {{ required "Environment name (.Values.tags.environment) is required" (.Values.tags.environment | default $tags.environment) }}
  location: {{ .Values.location }}
  owner:
    name: {{ required "A resource group ( .Values.resourceGroup ) is required for storage creation" .Values.resourceGroup | quote }}
  sku:
    name: Standard
  zoneRedundant: {{ .Values.zoneRedundant | default false }}

{{- if .Values.setup -}}
  {{- if .Values.setup.queues -}}
    {{- range $queue := .Values.setup.queues }}
---
apiVersion: servicebus.azure.com/v1alpha1api20210101preview
kind: NamespacesQueue
metadata:
  name: {{ $queue.name }}
spec:
  owner:
    name: servicebus-namespace-{{ template "hmcts.servicebus.releaseName" $ }}
    {{- end }}
  {{- end }}

  {{- if .Values.setup.topics -}}
    {{- range $topics := .Values.setup.topics }}
---
apiVersion: servicebus.azure.com/v1alpha1api20210101preview
kind: NamespacesTopic
metadata:
  name: {{ $topics.name }}
spec:
  owner:
    name: servicebus-namespace-{{ template "hmcts.servicebus.releaseName" $ }}
    {{- end }}
  {{- end }}
{{- end }}


---
apiVersion: managedidentity.azure.com/v1beta20181130
kind: UserAssignedIdentity
metadata:
  name: servicebus-identity-{{ template "hmcts.servicebus.releaseName" . }}
spec:
  tags:
    app.kubernetes.io_name: {{ template "hmcts.servicebus.releaseName" . }}
    helm.sh_chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    application: {{ required "An application tag name (.Values.tags.applicationName) is required"  (.Values.tags.applicationName | default $tags.applicationName) }}
    builtFrom: {{ required "Repo built from (.Values.tags.builtFrom) is required" (.Values.tags.builtFrom | default $tags.builtFrom) }}
    businessArea: {{ required "Business Area name (.Values.tags.businessArea) is required" (.Values.tags.businessArea | default $tags.businessArea) }}
    environment: {{ required "Environment name (.Values.tags.environment) is required" (.Values.tags.environment | default $tags.environment) }}
  location: {{ .Values.location }}
  owner:
    name: {{ required "A resource group ( .Values.resourceGroup ) is required for storage creation" .Values.resourceGroup | quote }}
  operatorSpec:
    configMaps:
      # Export the principalId, clientId and tenantId to a ConfigMap for use by our application and/or
      # other ASO resources such as RoleAssignments, KeyVaults, etc.
      principalId:
        name: identity-settings
        key: principalId
      clientId:
        name: identity-settings
        key: clientId


---
apiVersion: authorization.azure.com/v1beta20200801preview
kind: RoleAssignment
metadata:
  name: {{ uuidv4 }} # Should be UUID
spec:
  location: {{ .Values.location }}
  # This resource can be owner by any resource. In this example we've chosen a resource group for simplicity
  owner:
    name: {{ required "A resource group ( .Values.resourceGroup ) is required for storage creation" .Values.resourceGroup | quote }}
    group: resources.azure.com
    kind: ResourceGroup
  # This is the Principal ID of the AAD identity to which the role will be assigned
  principalIdFromConfig:
    name: identity-settings
    key: principalId
  roleDefinitionReference:
    # This ARM ID represents "Contributor" - you can read about other built in roles here: https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles
    armId: /subscriptions/{{ .Values.subscriptionId }}/providers/Microsoft.Authorization/roleDefinitions/090c5cfd-751d-490a-894a-3ce6f1109419
