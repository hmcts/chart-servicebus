---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentity
metadata:
  name: "{{ template "hmcts.releasename.v2" . }}-aad-id"
spec:
  resourceID: /subscriptions/8b6ea922-0862-443e-af15-6056e1c9b9a4/resourcegroups/aso-aks-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/aso-aks-mi
  clientID: 67316396-6e4c-430c-95ba-d7cf66a3b59e
---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentityBinding
metadata:
  name: "{{ template "hmcts.releasename.v2" . }}-add-binding"
spec:
  azureIdentity: "{{ template "hmcts.releasename.v2" . }}-aad-id"
  selector: servicebus
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "hmcts.releasename.v2" . }}-test-configmap
data:
  entrypoint.sh: |-
    #!/bin/sh -xv

    namespace="$1"
    queue_name="$2"
    for i in {1..10}; do az login --identity && break || sleep 20; done
    accesstoken=$(az account get-access-token --resource https://servicebus.azure.net | jq -r .accessToken)
    servicebus_url="servicebus.windows.net"
    queue_url="https://${namespace}.${servicebus_url}/${queue_name}"

    httpstatuscode=$(curl -v -X POST \
      -H "Authorization: $accesstoken" \
      -d 'This is a message.' \
      "${queue_url}/messages?api-version=2015-01" 2>&1 | grep 'HTTP/' | awk 'END{print $3}')
    [ "$httpstatuscode" = "201" ] && exit 0 || exit 1
---
{{- $queueName := (index .Values.setup.queues 0).name }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ template "hmcts.releasename.v2" . }}-test-service"
  annotations:
    "helm.sh/hook": test-success
  labels:
    aadpodidbinding: servicebus
spec:
  volumes:
    - name: configmap-volume
      configMap:
        defaultMode: 0755
        name: {{ template "hmcts.releasename.v2" . }}-test-configmap
  containers:
      - name: {{ template "hmcts.releasename.v2" . }}-test-service
        image: mcr.microsoft.com/azure-cli
        volumeMounts:
          - name: configmap-volume
            mountPath: /entrypoint
        env:
          - name: NAMESPACE
            value:  servicebus-namespace-{{ template "hmcts.servicebus.releaseName" . }}
        command: ["sh", "-c", "apk add --update --no-cache openssl ca-certificates jq curl  && /entrypoint/entrypoint.sh ${NAMESPACE} {{ $queueName }}"]
  restartPolicy: Never
